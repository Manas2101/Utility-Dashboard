<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Submit a New Automation Utility</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>

    :root { --red:#DB0011; --bg:#f7f8fa; --border:#dcdfe3; --radius:14px; --focus:#ffccd1; }

    body {margin:0;font-family:Arial, sans-serif;background:var(--bg);color:#222;}

    .wrapper {max-width:960px;margin:40px auto 80px;padding:0 28px;}

    h1 {font-size:26px;margin:0 0 22px;display:flex;align-items:center;gap:12px;color:#111;font-weight:600;}

    h1 i {color:var(--red);}

    form {background:#fff;padding:34px 38px 40px;border:1px solid #eceef0;border-radius:28px;box-shadow:0 8px 28px -6px rgba(0,0,0,.08),0 4px 12px rgba(0,0,0,.04);}

    fieldset {border:none;margin:0;padding:0 0 26px;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px 34px;}

    fieldset.meta-wide {grid-template-columns:1fr;}

    legend {font-size:14px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;color:#555;margin:0 0 12px;}

    .field {display:flex;flex-direction:column;gap:8px;}

    .field.half {grid-column:span 1;}

    .field.full {grid-column:1/-1;}

    label {font-size:13px;font-weight:600;letter-spacing:.4px;color:#222;display:flex;align-items:center;gap:6px;}

    label .req {color:var(--red);}    

    input[type=text], input[type=number], textarea, select {padding:11px 14px;font-size:14px;border:1px solid var(--border);border-radius:12px;background:#fff;font-family:inherit;resize:vertical;min-height:48px;}

    textarea {min-height:120px;line-height:1.4;}

    input:focus, textarea:focus, select:focus {outline:2px solid var(--focus);border-color:var(--red);}

    .hint {font-size:11px;color:#666;line-height:1.3;}

    .actions {display:flex;justify-content:flex-end;gap:16px;margin-top:10px;}

    .btn {border:none;border-radius:12px;padding:13px 22px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;letter-spacing:.3px;}

    .btn.cancel {background:#f0f0f0;color:#333;}

    .btn.cancel:hover {background:#e2e2e2;}

    .btn.primary {background:var(--red);color:#fff;box-shadow:0 4px 14px -4px rgba(219,0,17,.5);}

    .btn.primary:hover {background:#b9000e;}

    .two-col {display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:26px;}

    .error {font-size:11px;color:var(--red);font-weight:600;margin-top:-4px;}

    .json-preview {background:#0f1115;color:#d2e2ff;font-family:Consolas,monospace;font-size:12px;padding:14px 16px;border-radius:14px;max-height:300px;overflow:auto;line-height:1.4;}

    .preview-block {margin-top:34px;}

  .result-block {margin-top:34px;background:#fff;border:1px solid #eceef0;border-radius:18px;padding:18px 20px;}

  .result-block h2 {font-size:16px;margin:0 0 8px;color:#111;}

  .result-list {list-style:none;padding:0;margin:8px 0 0;}

  .result-list li {margin:6px 0;font-size:13px;color:#333;}

  .result-list a {color:#0b6efd;text-decoration:none;}

  .result-list a:hover {text-decoration:underline;}

    .status-bar {margin:30px 0 0;font-size:13px;color:#555;display:flex;align-items:center;gap:10px;}

    .pill {background:#fff;border:1px solid #ececec;border-radius:100px;padding:6px 14px;font-size:11px;letter-spacing:.5px;text-transform:uppercase;display:inline-flex;align-items:center;gap:6px;color:#444;}

    .required-note {font-size:11px;color:#777;margin:6px 0 30px;}

    .inline {display:flex;gap:14px;align-items:center;flex-wrap:wrap;}

    .group-label {font-size:12px;font-weight:700;text-transform:uppercase;color:#666;letter-spacing:.5px;margin:0 0 4px;}

    .flex-col {display:flex;flex-direction:column;gap:8px;}

    .top-nav {display:flex;justify-content:space-between;align-items:center;margin-bottom:34px;}

    .top-nav a {text-decoration:none;font-size:13px;color:#444;display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border-radius:10px;background:#fff;border:1px solid #e4e4e4;}

    .top-nav a:hover {background:#f5f5f5;}

    .badge-red {background:#ffe6e8;color:#b9000e;padding:4px 8px;font-size:11px;border-radius:8px;font-weight:600;letter-spacing:.4px;}

    .grid-slim {display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;}

    .field small.counter {font-size:10px;color:#888;margin-left:auto;}

  </style>

</head>

<body>

  <div class="wrapper">

    <div class="top-nav">

      <h1><i class="fa fa-plug"></i><span id="pageTitle">Submit a New Automation Utility</span></h1>

      <a href="/{{ app_name }}/home.html"><i class="fa fa-arrow-left"></i> Back to Dashboard</a>

    </div>

    <p class="required-note">Fields marked with <span class="req">*</span> are required.</p>

    <form id="utilityForm" novalidate>

      <fieldset>

        <legend>Identity</legend>

        <div class="field full">

          <label for="title">Utility Title <span class="req">*</span></label>

          <input id="title" name="title" type="text" placeholder="e.g., Jenkins CI/CD, Azure DevOps" required maxlength="120" />

          <div class="hint">A concise, descriptive name for the automation utility.</div>

          <div class="error" data-error-for="title"></div>

        </div>

        <div class="field">

          <label for="icon_url">Icon URL</label>

          <input id="icon_url" name="icon_url" type="text" placeholder="e.g., https://cdn.../jenkins.svg" />

          <div class="hint">Link to an SVG icon (prefer HSBC internal CDN or /static/*).</div>

        </div>

        <div class="field full">

          <label for="description">Description <span class="req">*</span></label>

          <textarea id="description" name="description" placeholder="Briefly describe the utility's purpose." required maxlength="600"></textarea>

          <div class="hint">A short overview of what this utility does.</div>

          <div class="error" data-error-for="description"></div>

        </div>

      </fieldset>

      <fieldset>

        <legend>Ownership</legend>

        <div class="field">

          <label for="developer">Developer/Team</label>

          <input id="developer" name="developer" type="text" placeholder="e.g., Core Engineering" />

          <div class="hint">Optional: team or individual maintaining this utility.</div>

          <div class="error" data-error-for="developer"></div>

        </div>

        <div class="field">

          <label for="developer_source">Developer Source</label>

          <select id="developer_source" name="developer_source">

            <option value="" disabled selected>-- Select Source --</option>

            <option value="internal">Internal (HSBC Team)</option>

            <option value="external">External (Vendor/Community)</option>

          </select>

          <div class="error" data-error-for="developer_source"></div>

        </div>

        <div class="field">

          <label for="committer">Committer (Employee ID) <span class="req">*</span></label>

          <input id="committer" name="committer" type="text" placeholder="e.g., 45099759" required maxlength="20" />

          <div class="error" data-error-for="committer"></div>

        </div>

      </fieldset>

      <fieldset>

        <legend>Technical</legend>

        <div class="field">

          <label for="server_url">Utility URL <span class="req">*</span></label>

          <input id="server_url" name="server_url" type="text" placeholder="e.g., http://your-utility.example.com" required />

        </div>

        <div class="field">

         <label for="source_code_url">Source Code URL <span class="req">*</span></label>

          <input id="source_code_url" name="source_code_url" type="text" placeholder="e.g., https://internal-git/..." required />

        </div>

        <div class="field">

          <label for="type">Category/Type</label>

          <input id="type" name="type" type="text" placeholder="e.g., CI/CD, Monitoring" />

        </div>

        <div class="field">

          <label for="source_language">Source Language</label>

          <input id="source_language" name="source_language" type="text" placeholder="e.g., Python, Java" />

        </div>

        <div class="field">

          <label for="status">Status</label>

          <select id="status" name="status">

            <option value="running" selected>Running</option>

            <option value="implementing">Implementing</option>

            <option value="available">Available</option>

          </select>

        </div>

      </fieldset>

      <fieldset class="meta-wide">

        <legend>Implementation</legend>

        <div class="field full">

          <label for="playbook">Playbook / Running Steps <span class="req">*</span></label>

          <textarea id="playbook" name="playbook" placeholder='List the steps to run the utility, prerequisites, commands, and expected outputs.' required></textarea>

          <div class="hint">Provide clear, executable steps to run the utility (commands, flags, environments).</div>

          <div class="error" data-error-for="playbook"></div>

        </div>

      </fieldset>

      <div class="actions">

        <button type="button" class="btn cancel" id="cancelBtn"><i class="fa fa-times"></i> Cancel</button>

        <button type="submit" class="btn primary" id="submitBtn"><i class="fa fa-paper-plane"></i> <span id="submitBtnText">Submit for Review</span></button>

      </div>

    </form>

    <div class="preview-block" id="previewBlock" style="display:none;">

      <h2 style="font-size:18px;display:flex;align-items:center;gap:10px;margin:50px 0 14px;"><i class="fa fa-eye"></i>Submission Preview</h2>

      <div class="json-preview" id="jsonPreview"></div>

    </div>

    <div class="result-block" id="resultBlock" style="display:none;" data-repo-url="{{ repo_url }}">

      <h2>Access links</h2>

      <ul class="result-list" id="resultList"></ul>

    </div>

  </div>

  <script>

    (function(){

      const form = document.getElementById('utilityForm');

      const previewBlock = document.getElementById('previewBlock');

      const preview = document.getElementById('jsonPreview');

      const resultBlock = document.getElementById('resultBlock');

      const resultList = document.getElementById('resultList');

      const cancelBtn = document.getElementById('cancelBtn');

      cancelBtn.addEventListener('click', ()=>{ window.location.href='/{{ app_name }}/home.html'; });

      

      // Check if we're in edit mode

      let isEditMode = false;

      let editUtilityId = null;

      const editData = sessionStorage.getItem('editUtility');

      if (editData) {

        try {

          const utility = JSON.parse(editData);

          isEditMode = true;

          editUtilityId = utility.id;

          

          // Update UI for edit mode

          document.getElementById('pageTitle').textContent = 'Update Automation Utility';

          document.getElementById('submitBtnText').textContent = 'Update Utility';

          

          // Pre-fill form fields

          if (utility.title) form.title.value = utility.title;

          if (utility.icon_url) form.icon_url.value = utility.icon_url;

          if (utility.description) form.description.value = utility.description;

          if (utility.developer) form.developer.value = utility.developer;

          if (utility.developer_source) form.developer_source.value = utility.developer_source;

          if (utility.committer) form.committer.value = utility.committer;

          if (utility.server_url) form.server_url.value = utility.server_url;

          if (utility.source_code_url) form.source_code_url.value = utility.source_code_url;

          if (utility.type) form.type.value = utility.type;

          if (utility.source_language) form.source_language.value = utility.source_language;

          if (utility.status) form.status.value = utility.status;

          if (utility.playbook) form.playbook.value = utility.playbook;

          

          // Clear sessionStorage after loading

          sessionStorage.removeItem('editUtility');

        } catch (e) {

          console.error('Failed to load edit data:', e);

        }

      }

 

      function setError(field, message){

        const err = document.querySelector(`.error[data-error-for="${field}"]`);

        if(err){ err.textContent = message || ''; }

      }

      function clearErrors(){

        form.querySelectorAll('.error').forEach(e=> e.textContent='');

      }

      // No config JSON anymore

 

      form.addEventListener('submit', async (e)=>{

        e.preventDefault();

        clearErrors();

        const requiredFields = ['title','description','committer','server_url','source_code_url','playbook'];

        let hasError = false;

        requiredFields.forEach(f=>{

          const el = document.getElementById(f);

            if(!el || !el.value.trim()) { setError(f, 'Required'); hasError = true; }

        });

        if(hasError) { window.scrollTo({top:0,behavior:'smooth'}); return; }

 

        const data = {

          id: isEditMode ? editUtilityId : Date.now().toString(),

          title: form.title.value.trim(),

            icon_url: form.icon_url.value.trim() || 'static/placeholder.svg',

            description: form.description.value.trim(),

            developer: form.developer.value.trim(),

            developer_source: form.developer_source.value,

            server_url: form.server_url.value.trim(),

            source_code_url: form.source_code_url.value.trim(),

            type: form.type.value.trim(),

            status: form.status.value,

            source_language: form.source_language.value.trim(),

      // transport_type removed

      // utility_tools_number removed

            committer: form.committer.value.trim(),

      playbook: form.playbook.value.trim(),

            likes: 0

        };

 

        // attempt POST (create) or PUT (update) to backend if route exists

        let saved = false;

        let respJson = null;

        try {

          const method = isEditMode ? 'PUT' : 'POST';

          const url = isEditMode ? `/{{ app_name }}/api/utilities/${editUtilityId}` : '/{{ app_name }}/api/utilities';

          const resp = await fetch(url, {method: method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});

          if(resp.ok){ saved = true; respJson = await resp.json(); }

        } catch(_) {}

 

        preview.textContent = JSON.stringify(data, null, 2);

        previewBlock.style.display = 'block';

        // Minimal, non-refresh result display for new users

        resultList.innerHTML = '';

        const items = [];

        // Repo link from response or env fallback shown by backend

        if(saved && respJson && respJson.repository){

          items.push({label:'Repository', url: respJson.repository});

        } else {

          const repoUrl = '{{ repo_url|default("") }}';

          if(repoUrl){ items.push({label:'Repository', url: repoUrl}); }

        }

        // PR link

        if(saved && respJson && respJson.pr && respJson.pr.pr && respJson.pr.pr.url){

          items.push({label:'Pull Request', url: respJson.pr.pr.url});

        }

        // Commit title/name (from backend commit_message or derived)

        let commitTitle = '';

        if(saved && respJson && respJson.commit_message){

          commitTitle = respJson.commit_message;

        } else if(saved && respJson && respJson.pr && respJson.pr.steps){

          const titleStep = respJson.pr.steps.find(s=> s.step === 'create PR');

          if(titleStep && typeof titleStep.out === 'string'){

            // fallback, may contain response JSON; leave blank if noisy

          }

        }

        if(!commitTitle && data && data.title){

          commitTitle = 'utility added: ' + data.title;

        }

        if(commitTitle){

          items.push({label:'Commit title', text: commitTitle});

        }

        // Render items

        items.forEach(it=>{

          const li = document.createElement('li');

          if(it.url){

            li.innerHTML = `${it.label}: <a href="${it.url}" target="_blank" rel="noopener">${it.url}</a>`;

          } else {

            li.textContent = `${it.label}: ${it.text}`;

          }

          resultList.appendChild(li);

        });

        resultBlock.style.display = items.length ? 'block' : 'none';

 

        if(!saved){

          preview.insertAdjacentHTML('afterbegin','// UI-ONLY MODE: Not persisted to server. Copy JSON manually if needed.\n');

          window.scrollTo({top: previewBlock.offsetTop - 20, behavior:'smooth'});

        } else {

          // Do not refresh; scroll to links for easy access

          window.scrollTo({top: resultBlock.offsetTop - 20, behavior:'smooth'});

        }

      });

    })();

  </script>

</body>

</html>