<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Submit a New Automation Utility</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root { --red:#DB0011; --bg:#0a0e27; --border:rgba(255,255,255,0.1); --radius:14px; --focus:rgba(219,0,17,0.3); }

    * {box-sizing:border-box;}

    body {margin:0;font-family:'Inter', Arial, sans-serif;background:var(--bg);color:#fff;min-height:100vh;position:relative;overflow-x:hidden;}

    body::before {content:''; position:fixed; top:0; left:0; right:0; bottom:0; background:radial-gradient(circle at 20% 50%, rgba(219,0,17,0.15) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(0,135,90,0.1) 0%, transparent 50%); pointer-events:none; z-index:0;}

    .wrapper {max-width:960px;margin:40px auto 80px;padding:0 28px;position:relative;z-index:1;}

    h1 {font-size:32px;margin:0 0 32px;display:flex;align-items:center;gap:12px;color:#fff;font-weight:700;text-shadow:0 2px 20px rgba(219,0,17,0.3);}

    h1 i {color:var(--red);filter:drop-shadow(0 0 20px rgba(219,0,17,0.6));}

    form {background:rgba(255,255,255,0.03);backdrop-filter:blur(20px);padding:40px 44px 46px;border:1px solid rgba(255,255,255,0.08);border-radius:24px;box-shadow:0 8px 32px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,0.1);}

    fieldset {border:none;margin:0;padding:0 0 26px;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px 34px;}

    fieldset.meta-wide {grid-template-columns:1fr;}

    legend {font-size:14px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin:0 0 16px;}

    .field {display:flex;flex-direction:column;gap:8px;}

    .field.half {grid-column:span 1;}

    .field.full {grid-column:1/-1;}

    label {font-size:13px;font-weight:600;letter-spacing:.4px;color:rgba(255,255,255,0.9);display:flex;align-items:center;gap:6px;}

    label .req {color:var(--red);}    

    input[type=text], input[type=number], textarea, select {padding:12px 16px;font-size:14px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,0.05);color:#fff;font-family:inherit;resize:vertical;min-height:48px;}

    input::placeholder, textarea::placeholder {color:rgba(255,255,255,0.4);}

    textarea {min-height:120px;line-height:1.5;}

    input:focus, textarea:focus, select:focus {outline:none;border-color:var(--red);background:rgba(255,255,255,0.08);box-shadow:0 0 0 3px var(--focus);}

    .hint {font-size:11px;color:rgba(255,255,255,0.5);line-height:1.4;}

    .actions {display:flex;justify-content:flex-end;gap:16px;margin-top:10px;}

    .btn {border:none;border-radius:12px;padding:13px 22px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;letter-spacing:.3px;}

    .btn.cancel {background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.8);border:1px solid rgba(255,255,255,0.1);}

    .btn.cancel:hover {background:rgba(255,255,255,0.12);}

    .btn.primary {background:linear-gradient(135deg,#DB0011,#FF4444);color:#fff;box-shadow:0 4px 16px rgba(219,0,17,.4);border:none;}

    .btn.primary:hover {transform:translateY(-2px);box-shadow:0 6px 24px rgba(219,0,17,.6);}

    .two-col {display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:26px;}

    .error {font-size:11px;color:#FF6B6B;font-weight:600;margin-top:-4px;}

    .json-preview {background:rgba(0,0,0,0.4);color:#d2e2ff;font-family:Consolas,monospace;font-size:12px;padding:16px 18px;border-radius:14px;max-height:300px;overflow:auto;line-height:1.5;border:1px solid rgba(255,255,255,0.1);}

    .preview-block {margin-top:34px;}

  .result-block {margin-top:34px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:18px;padding:20px 24px;backdrop-filter:blur(10px);}

  .result-block h2 {font-size:16px;margin:0 0 12px;color:#fff;font-weight:600;}

  .result-list {list-style:none;padding:0;margin:8px 0 0;}

  .result-list li {margin:8px 0;font-size:13px;color:rgba(255,255,255,0.8);}

  .result-list a {color:#00FF88;text-decoration:none;}

  .result-list a:hover {text-decoration:underline;}

    .status-bar {margin:30px 0 0;font-size:13px;color:rgba(255,255,255,0.6);display:flex;align-items:center;gap:10px;}

    .pill {background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:100px;padding:6px 14px;font-size:11px;letter-spacing:.5px;text-transform:uppercase;display:inline-flex;align-items:center;gap:6px;color:rgba(255,255,255,0.7);}

    .required-note {font-size:11px;color:rgba(255,255,255,0.5);margin:6px 0 30px;}

    .inline {display:flex;gap:14px;align-items:center;flex-wrap:wrap;}

    .group-label {font-size:12px;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.6);letter-spacing:.5px;margin:0 0 4px;}

    .flex-col {display:flex;flex-direction:column;gap:8px;}

    .top-nav {display:flex;justify-content:space-between;align-items:center;margin-bottom:34px;}

    .top-nav a {text-decoration:none;font-size:13px;color:rgba(255,255,255,0.9);display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);transition:all .3s;}

    .top-nav a:hover {background:rgba(255,255,255,0.1);border-color:rgba(219,0,17,0.5);transform:translateX(-4px);}

    .badge-red {background:#ffe6e8;color:#b9000e;padding:4px 8px;font-size:11px;border-radius:8px;font-weight:600;letter-spacing:.4px;}

    .grid-slim {display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;}

    .field small.counter {font-size:10px;color:#888;margin-left:auto;}

    .icon-upload-container {display:flex;gap:16px;align-items:flex-start;}

    .icon-upload-container .field {flex:1;}

    .upload-preview {width:80px;height:80px;border:2px dashed rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03);overflow:hidden;}

    .upload-preview img {width:100%;height:100%;object-fit:contain;}

    .upload-preview .placeholder {color:rgba(255,255,255,0.4);font-size:12px;text-align:center;padding:8px;}

    .file-input-wrapper {position:relative;overflow:hidden;display:inline-block;}

    .file-input-wrapper input[type=file] {position:absolute;left:-9999px;}

    .file-input-label {display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:12px;cursor:pointer;font-size:13px;color:rgba(255,255,255,0.9);transition:all .3s;}

    .file-input-label:hover {background:rgba(255,255,255,0.12);border-color:rgba(219,0,17,0.5);}

    .upload-status {font-size:11px;margin-top:6px;color:rgba(255,255,255,0.6);}

    .upload-status.success {color:#00FF88;}

    .upload-status.error {color:#FF6B6B;}

  </style>

</head>

<body>

  <div class="wrapper">

    <div class="top-nav">

      <h1><i class="fa fa-plug"></i><span id="pageTitle">Submit a New Automation Utility</span></h1>

      <a href="/{{ app_name }}/home.html"><i class="fa fa-arrow-left"></i> Back to Dashboard</a>

    </div>

    <p class="required-note">Fields marked with <span class="req">*</span> are required.</p>

    <form id="utilityForm" novalidate>

      <fieldset>

        <legend>Identity</legend>

        <div class="field full">

          <label for="title">Utility Title <span class="req">*</span></label>

          <input id="title" name="title" type="text" placeholder="e.g., Jenkins CI/CD, Azure DevOps" required maxlength="120" />

          <div class="hint">A concise, descriptive name for the automation utility.</div>

          <div class="error" data-error-for="title"></div>

        </div>

        <div class="field full">

          <label for="icon_url">Icon URL</label>

          <div class="icon-upload-container">

            <div class="field" style="margin:0;">

              <input id="icon_url" name="icon_url" type="text" placeholder="e.g., https://cdn.../jenkins.svg or upload an image" />

              <div class="hint">Enter a URL or upload an image file (PNG, JPG, SVG).</div>

              <div class="file-input-wrapper">

                <input type="file" id="iconFile" accept="image/png,image/jpeg,image/jpg,image/svg+xml" />

                <label for="iconFile" class="file-input-label">

                  <i class="fas fa-upload"></i> Upload Image

                </label>

              </div>

              <div id="uploadStatus" class="upload-status"></div>

            </div>

            <div class="upload-preview" id="iconPreview">

              <div class="placeholder">No icon</div>

            </div>

          </div>

        </div>

        <div class="field full">

          <label for="description">Description <span class="req">*</span></label>

          <textarea id="description" name="description" placeholder="Briefly describe the utility's purpose." required maxlength="600"></textarea>

          <div class="hint">A short overview of what this utility does.</div>

          <div class="error" data-error-for="description"></div>

        </div>

      </fieldset>

      <fieldset>

        <legend>Ownership</legend>

        <div class="field">

          <label for="developer">Developer/Team</label>

          <input id="developer" name="developer" type="text" placeholder="e.g., Core Engineering" />

          <div class="hint">Optional: team or individual maintaining this utility.</div>

          <div class="error" data-error-for="developer"></div>

        </div>

        <div class="field">

          <label for="developer_source">Developer Source</label>

          <select id="developer_source" name="developer_source">

            <option value="" disabled selected>-- Select Source --</option>

            <option value="internal">Internal (HSBC Team)</option>

            <option value="external">External (Vendor/Community)</option>

          </select>

          <div class="error" data-error-for="developer_source"></div>

        </div>

        <div class="field">

          <label for="committer">Committer (Employee ID) <span class="req">*</span></label>

          <input id="committer" name="committer" type="text" placeholder="e.g., 45099759" required maxlength="20" />

          <div class="error" data-error-for="committer"></div>

        </div>

      </fieldset>

      <fieldset>

        <legend>Technical</legend>

        <div class="field">

          <label for="server_url">Utility URL <span class="req">*</span></label>

          <input id="server_url" name="server_url" type="text" placeholder="e.g., http://your-utility.example.com" required />

        </div>

        <div class="field">

         <label for="source_code_url">Source Code URL <span class="req">*</span></label>

          <input id="source_code_url" name="source_code_url" type="text" placeholder="e.g., https://internal-git/..." required />

        </div>

        <div class="field">

          <label for="type">Category/Type</label>

          <input id="type" name="type" type="text" placeholder="e.g., CI/CD, Monitoring" />

        </div>

        <div class="field">

          <label for="source_language">Source Language</label>

          <input id="source_language" name="source_language" type="text" placeholder="e.g., Python, Java" />

        </div>

        <div class="field">

          <label for="status">Status</label>

          <select id="status" name="status">

            <option value="running" selected>Running</option>

            <option value="implementing">Implementing</option>

            <option value="available">Available</option>

          </select>

        </div>

      </fieldset>

      <fieldset class="meta-wide">

        <legend>Implementation</legend>

        <div class="field full">

          <label for="playbook">Playbook / Running Steps <span class="req">*</span></label>

          <textarea id="playbook" name="playbook" placeholder='List the steps to run the utility, prerequisites, commands, and expected outputs.' required></textarea>

          <div class="hint">Provide clear, executable steps to run the utility (commands, flags, environments).</div>

          <div class="error" data-error-for="playbook"></div>

        </div>

      </fieldset>

      <div class="actions">

        <button type="button" class="btn cancel" id="cancelBtn"><i class="fa fa-times"></i> Cancel</button>

        <button type="submit" class="btn primary" id="submitBtn"><i class="fa fa-paper-plane"></i> <span id="submitBtnText">Submit for Review</span></button>

      </div>

    </form>

    <div class="preview-block" id="previewBlock" style="display:none;">

      <h2 style="font-size:18px;display:flex;align-items:center;gap:10px;margin:50px 0 14px;"><i class="fa fa-eye"></i>Submission Preview</h2>

      <div class="json-preview" id="jsonPreview"></div>

    </div>

    <div class="result-block" id="resultBlock" style="display:none;" data-repo-url="{{ repo_url }}">

      <h2>Access links</h2>

      <ul class="result-list" id="resultList"></ul>

    </div>

  </div>

  <script>

    (function(){

      const form = document.getElementById('utilityForm');

      const previewBlock = document.getElementById('previewBlock');

      const preview = document.getElementById('jsonPreview');

      const resultBlock = document.getElementById('resultBlock');

      const resultList = document.getElementById('resultList');

      const cancelBtn = document.getElementById('cancelBtn');

      cancelBtn.addEventListener('click', ()=>{ window.location.href='/{{ app_name }}/home.html'; });

      

      // Handle icon upload and preview

      const iconFileInput = document.getElementById('iconFile');

      const iconUrlInput = document.getElementById('icon_url');

      const iconPreview = document.getElementById('iconPreview');

      const uploadStatus = document.getElementById('uploadStatus');

      

      // Update preview when URL changes

      iconUrlInput.addEventListener('input', function() {

        const url = this.value.trim();

        if (url) {

          iconPreview.innerHTML = `<img src="${url}" alt="Icon preview" onerror="this.parentElement.innerHTML='<div class=\'placeholder\'>Invalid image</div>'" />`;

        } else {

          iconPreview.innerHTML = '<div class="placeholder">No icon</div>';

        }

      });

      

      // Handle file upload

      iconFileInput.addEventListener('change', async function(e) {

        const file = e.target.files[0];

        if (!file) return;

        

        // Validate file type

        const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];

        if (!validTypes.includes(file.type)) {

          uploadStatus.textContent = 'Invalid file type. Please upload PNG, JPG, or SVG.';

          uploadStatus.className = 'upload-status error';

          return;

        }

        

        // Validate file size (max 2MB)

        if (file.size > 2 * 1024 * 1024) {

          uploadStatus.textContent = 'File too large. Maximum size is 2MB.';

          uploadStatus.className = 'upload-status error';

          return;

        }

        

        uploadStatus.textContent = 'Uploading...';

        uploadStatus.className = 'upload-status';

        

        try {

          const formData = new FormData();

          formData.append('icon', file);

          

          const response = await fetch('/{{ app_name }}/api/upload-icon', {

            method: 'POST',

            body: formData

          });

          

          if (response.ok) {

            const result = await response.json();

            iconUrlInput.value = result.url;

            iconPreview.innerHTML = `<img src="${result.url}" alt="Uploaded icon" />`;

            uploadStatus.textContent = 'âœ“ Upload successful';

            uploadStatus.className = 'upload-status success';

          } else {

            const error = await response.json();

            uploadStatus.textContent = `Upload failed: ${error.error || 'Unknown error'}`;

            uploadStatus.className = 'upload-status error';

          }

        } catch (error) {

          console.error('Upload error:', error);

          uploadStatus.textContent = `Upload failed: ${error.message}`;

          uploadStatus.className = 'upload-status error';

        }

      });

      

      // Check if we're in edit mode

      let isEditMode = false;

      let editUtilityId = null;

      const editData = sessionStorage.getItem('editUtility');

      if (editData) {

        try {

          const utility = JSON.parse(editData);

          isEditMode = true;

          editUtilityId = utility.id;

          

          // Update UI for edit mode

          document.getElementById('pageTitle').textContent = 'Update Automation Utility';

          document.getElementById('submitBtnText').textContent = 'Update Utility';

          

          // Pre-fill form fields

          if (utility.title) form.title.value = utility.title;

          if (utility.icon_url) {

            form.icon_url.value = utility.icon_url;

            iconPreview.innerHTML = `<img src="${utility.icon_url}" alt="Current icon" onerror="this.parentElement.innerHTML='<div class=\'placeholder\'>Invalid image</div>'" />`;

          }

          if (utility.description) form.description.value = utility.description;

          if (utility.developer) form.developer.value = utility.developer;

          if (utility.developer_source) form.developer_source.value = utility.developer_source;

          if (utility.committer) form.committer.value = utility.committer;

          if (utility.server_url) form.server_url.value = utility.server_url;

          if (utility.source_code_url) form.source_code_url.value = utility.source_code_url;

          if (utility.type) form.type.value = utility.type;

          if (utility.source_language) form.source_language.value = utility.source_language;

          if (utility.status) form.status.value = utility.status;

          if (utility.playbook) form.playbook.value = utility.playbook;

          

          // Show preview in edit mode

          const previewData = {

            id: utility.id,

            title: utility.title,

            icon_url: utility.icon_url,

            description: utility.description,

            developer: utility.developer,

            developer_source: utility.developer_source,

            server_url: utility.server_url,

            source_code_url: utility.source_code_url,

            type: utility.type,

            status: utility.status,

            source_language: utility.source_language,

            committer: utility.committer,

            playbook: utility.playbook,

            likes: utility.likes || 0

          };

          

          preview.textContent = JSON.stringify(previewData, null, 2);

          previewBlock.style.display = 'block';

          

          // Show result block with repository link in edit mode

          resultList.innerHTML = '';

          const repoUrl = '{{ repo_url|default("") }}';

          if (repoUrl) {

            const li = document.createElement('li');

            li.innerHTML = `Repository: <a href="${repoUrl}" target="_blank" rel="noopener">${repoUrl}</a>`;

            resultList.appendChild(li);

            resultBlock.style.display = 'block';

          }

          

          // Clear sessionStorage after loading

          sessionStorage.removeItem('editUtility');

        } catch (e) {

          console.error('Failed to load edit data:', e);

        }

      }

 

      function setError(field, message){

        const err = document.querySelector(`.error[data-error-for="${field}"]`);

        if(err){ err.textContent = message || ''; }

      }

      function clearErrors(){

        form.querySelectorAll('.error').forEach(e=> e.textContent='');

      }

      // No config JSON anymore

 

      form.addEventListener('submit', async (e)=>{

        e.preventDefault();

        clearErrors();

        const requiredFields = ['title','description','committer','server_url','source_code_url','playbook'];

        let hasError = false;

        requiredFields.forEach(f=>{

          const el = document.getElementById(f);

            if(!el || !el.value.trim()) { setError(f, 'Required'); hasError = true; }

        });

        if(hasError) { window.scrollTo({top:0,behavior:'smooth'}); return; }

 

        const data = {

          id: isEditMode ? editUtilityId : Date.now().toString(),

          title: form.title.value.trim(),

            icon_url: form.icon_url.value.trim() || 'static/placeholder.svg',

            description: form.description.value.trim(),

            developer: form.developer.value.trim(),

            developer_source: form.developer_source.value,

            server_url: form.server_url.value.trim(),

            source_code_url: form.source_code_url.value.trim(),

            type: form.type.value.trim(),

            status: form.status.value,

            source_language: form.source_language.value.trim(),

      // transport_type removed

      // utility_tools_number removed

            committer: form.committer.value.trim(),

      playbook: form.playbook.value.trim(),

            likes: 0

        };

 

        // attempt POST (create) or PUT (update) to backend if route exists

        let saved = false;

        let respJson = null;

        try {

          const method = isEditMode ? 'PUT' : 'POST';

          const url = isEditMode ? `/{{ app_name }}/api/utilities/${editUtilityId}` : '/{{ app_name }}/api/utilities';

          const resp = await fetch(url, {method: method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});

          if(resp.ok){ 

            saved = true; 

            respJson = await resp.json(); 

            console.log('Backend response:', respJson);

          } else {

            console.error('Backend error:', resp.status, await resp.text());

          }

        } catch(err) {

          console.error('Request failed:', err);

        }

 

        preview.textContent = JSON.stringify(data, null, 2);

        previewBlock.style.display = 'block';

        // Minimal, non-refresh result display for new users

        resultList.innerHTML = '';

        const items = [];

        // Repo link from response or env fallback shown by backend

        if(saved && respJson && respJson.repository){

          items.push({label:'Repository', url: respJson.repository});

        } else {

          const repoUrl = '{{ repo_url|default("") }}';

          if(repoUrl){ items.push({label:'Repository', url: repoUrl}); }

        }

        // PR link

        if(saved && respJson && respJson.pr && respJson.pr.pr && respJson.pr.pr.url){

          items.push({label:'Pull Request', url: respJson.pr.pr.url});

        }

        // Commit title/name (from backend commit_message or derived)

        let commitTitle = '';

        if(saved && respJson && respJson.commit_message){

          commitTitle = respJson.commit_message;

        } else if(saved && respJson && respJson.pr && respJson.pr.steps){

          const titleStep = respJson.pr.steps.find(s=> s.step === 'create PR');

          if(titleStep && typeof titleStep.out === 'string'){

            // fallback, may contain response JSON; leave blank if noisy

          }

        }

        if(!commitTitle && data && data.title){

          commitTitle = 'utility added: ' + data.title;

        }

        if(commitTitle){

          items.push({label:'Commit title', text: commitTitle});

        }

        // Render items

        items.forEach(it=>{

          const li = document.createElement('li');

          if(it.url){

            li.innerHTML = `${it.label}: <a href="${it.url}" target="_blank" rel="noopener">${it.url}</a>`;

          } else {

            li.textContent = `${it.label}: ${it.text}`;

          }

          resultList.appendChild(li);

        });

        resultBlock.style.display = items.length ? 'block' : 'none';

 

        if(!saved){

          preview.insertAdjacentHTML('afterbegin','// UI-ONLY MODE: Not persisted to server. Copy JSON manually if needed.\n');

          window.scrollTo({top: previewBlock.offsetTop - 20, behavior:'smooth'});

        } else {

          // Do not refresh; scroll to links for easy access

          window.scrollTo({top: resultBlock.offsetTop - 20, behavior:'smooth'});

        }

      });

    })();

  </script>

</body>

</html>